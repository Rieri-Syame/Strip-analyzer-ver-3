<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Strip Analyzer</title>

  <!-- Configure OpenCV.js and locate the .wasm file -->
  <script>
    var Module = {
      locateFile: function(path) {
        return 'https://docs.opencv.org/4.7.0/' + path;
      },
      onRuntimeInitialized: function() {
        document.getElementById('loading').textContent = '✅ OpenCV.js ready.';
        document.getElementById('imageInput').disabled = false;
        document.getElementById('uploadBtn').disabled = false;
      }
    };
  </script>

  <!-- Load OpenCV.js asynchronously -->
  <script async src="https://docs.opencv.org/4.7.0/opencv.js"></script>

  <style>
    body { font-family: sans-serif; padding: 20px; }
    .tabs { display:flex; border-bottom:1px solid #ccc; margin-bottom:10px; list-style:none; padding:0; }
    .tabs li { padding:10px 20px; cursor:pointer; }
    .tabs li.active { border-bottom:3px solid #007bff; font-weight:bold; }
    .tab-content > div { display:none; }
    .tab-content > div.active { display:block; }
    #canvasContainer { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
    canvas { border:1px solid #ccc; max-width:45vw; }
    #output { margin-top:20px; font-size:1.1rem; }
    .result { margin:4px 0; }
    #uploadBtn { margin-top:10px; padding:8px 12px; font-size:1rem; }
    label { display:block; margin-top:10px; }
    #userNameInput { width: 100%; max-width:300px; padding:4px; margin-left:8px; }
  </style>
</head>
<body>
  <h2>Test-Strip Analyzer</h2>
  <ul class="tabs">
    <li data-tab="analyze" class="active">Analyze</li>
    <li data-tab="saved">Saved</li>
  </ul>
  <div class="tab-content">
    <div id="analyze" class="active">
      <p>Upload a photo of your card with 4 black corner markers.</p>
      <div id="loading">Loading OpenCV.js…</div>
      <input id="imageInput" type="file" accept="image/*" disabled>
      <div id="canvasContainer">
        <canvas id="canvasOutput"></canvas>
        <canvas id="canvasWarped"></canvas>
      </div>
      <div id="output">
        <div class="result">Glucose: <span id="res-glucose">—</span></div>
        <div class="result">Protein: <span id="res-protein">—</span></div>
        <div class="result">Nitrite: <span id="res-nitrite">—</span></div>
        <div class="result">Leukocyte: <span id="res-leukocyte">—</span></div>
      </div>
      <label>
        Name:
        <input type="text" id="userNameInput" placeholder="e.g. Paolo Miguel Chua Navarro">
      </label>
      <button id="uploadBtn" disabled>Upload to Google Drive</button>
    </div>
    <div id="saved">
      <h3>Last Analyzed Image</h3>
      <div id="saved-image-container">No image saved yet.</div>
    </div>
  </div>

  <script>
    const references = {
      glucose: [
        { hex: '#7dcff4', label: 'Negative' },
        { hex: '#67b492', label: '+/-100' },
        { hex: '#6ba864', label: '+250' },
        { hex: '#7c7d39', label: '++500' },
        { hex: '#654224', label: '+++1000' }
      ],
      protein: [
        { hex: '#f4ee63', label: 'Negative' },
        { hex: '#e7e785', label: 'Trace' },
        { hex: '#dce480', label: '+30' },
        { hex: '#b4cf80', label: '++100' },
        { hex: '#a2ca95', label: '+++300' },
        { hex: '#78b289', label: '++++1000' }
      ],
      nitrite: [
        { hex: '#fef6df', label: 'Negative' },
        { hex: '#fae3e9', label: 'Trace' },
        { hex: '#d75f9f', label: 'Positive' }
      ],
      leukocyte: [
        { hex: '#fef1de', label: 'Negative' },
        { hex: '#f9e2c8', label: '++25' },
        { hex: '#f6dee4', label: '++75' },
        { hex: '#c298bd', label: '++500' }
      ]
    };

    // Tabs
    document.querySelectorAll('.tabs li').forEach(tab => {
      tab.onclick = () => {
        document.querySelectorAll('.tabs li').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        const tgt = tab.dataset.tab; document.querySelectorAll('.tab-content > div')
          .forEach(div => div.classList.toggle('active', div.id === tgt));
      };
    });

    // Restore saved image
    document.addEventListener('DOMContentLoaded', () => {
      const d = localStorage.getItem('lastAnalyzedImage');
      if (d) document.getElementById('saved-image-container').innerHTML = `<img src="${d}" style="max-width:100%;">`;
    });

    const input = document.getElementById('imageInput');
    const canvas = document.getElementById('canvasOutput');
    const warped = document.getElementById('canvasWarped');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    const uploadBtn = document.getElementById('uploadBtn');

    input.onchange = () => {
      const file = input.files[0]; const img = new Image();
      img.onload = () => { canvas.width = img.width; canvas.height = img.height; ctx.drawImage(img, 0, 0); detectAndWarp(); };
      img.src = URL.createObjectURL(file);
    };

    function detectAndWarp() {
      // ... detection logic ...
      analyzePads(warped); saveLastImage();
    }

    // ... analyzePads, saveLastImage, interpretColor ...

    function uploadToDrive() {
  const name = document.getElementById('userNameInput').value.trim();
  if (!name) {
    alert('Please enter your name');
    return;
  }

  const ts = new Date().toISOString()
    .replace(/[:.]/g,'-')
    .replace(/T/,'_')
    .replace(/Z$/,'');

  const filename = `${name}_${ts}.png`;
  console.log('Uploading with filename:', filename);

  const payload = {
    image:    warped.toDataURL('image/png'),
    filename: filename
  };

  fetch('https://cors-proxy-uploader.onrender.com/upload', {
    method:  'POST',
    headers: { 'Content-Type': 'application/json' },
    body:    JSON.stringify(payload)
  })
  .then(res => {
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return res.json();
  })
  .then(data => {
    console.log('Full upload response:', data);
    // try a few common property names
    const fileId = data.id || data.fileId || data.file_id 
                || (data.result && data.result.id)
                || 'unknown';
    alert(`✅ Uploaded! File ID: ${fileId}`);
  })
  .catch(err => {
    alert('❌ Upload failed: ' + err.message);
    console.error(err);
  });
}
    document.getElementById('uploadBtn').addEventListener('click', uploadToDrive);
  </script>
</body>
</html>
